{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% if mode == 'edit' %}Modifier{% else %}Ajouter{% endif %} un produit – Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="{% url 'admin_dashboard' %}">Dashboard Admin</a>
      <div class="d-flex">
        <a href="{% url 'admin_produits_list' %}" class="btn btn-outline-light btn-sm">Retour liste</a>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    {% include 'includes/back_button.html' %}
    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
      {% endfor %}
    {% endif %}

    {% if form and form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <h1 class="h4 mb-3">{% if mode == 'edit' %}Modifier{% else %}Ajouter{% endif %} un produit</h1>

    <form method="post" enctype="multipart/form-data" class="row g-3">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nom <span class="text-danger">*</span></label>
          <input type="text" name="nom" class="form-control {% if form and form.nom.errors %}is-invalid{% endif %}"
                 value="{% if form %}{{ form.nom.value|default_if_none:'' }}{% else %}{{ produit.nom|default:'' }}{% endif %}" required />
          {% if form and form.nom.errors %}
            <div class="invalid-feedback">{{ form.nom.errors|first }}</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <label class="form-label">Prix <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="number" step="0.01" min="0" name="prix" 
                   class="form-control {% if form and form.prix.errors %}is-invalid{% endif %}"
                   value="{% if form %}{{ form.prix.value|default_if_none:'' }}{% else %}{{ produit.prix|default:'' }}{% endif %}" required />
            <span class="input-group-text">FCFA</span>
          </div>
          {% if form and form.prix.errors %}
            <div class="invalid-feedback">{{ form.prix.errors|first }}</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <label class="form-label">Stock <span class="text-danger">*</span></label>
          <input type="number" min="0" step="1" name="stock"
                 class="form-control {% if form and form.stock.errors %}is-invalid{% endif %}"
                 value="{% if form %}{{ form.stock.value|default_if_none:'0' }}{% else %}{{ produit.stock|default:'0' }}{% endif %}" required />
          {% if form and form.stock.errors %}
            <div class="invalid-feedback">{{ form.stock.errors|first }}</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <label class="form-label">Catégorie <span class="text-danger">*</span></label>
          <select name="categorie" class="form-select {% if form and form.categorie.errors %}is-invalid{% endif %}" required>
            <option value="">-- Choisir --</option>
            {% for c in categories %}
              <option value="{{ c.id }}"
                {% if form and form.categorie.value %}
                  {% if form.categorie.value|stringformat:'s' == c.id|stringformat:'s' %}selected{% endif %}
                {% elif produit %}
                  {% if produit.categorie.id|stringformat:'s' == c.id|stringformat:'s' %}selected{% endif %}
                {% endif %}
              >{{ c.nom }}</option>
            {% endfor %}
          </select>
          {% if form and form.categorie.errors %}
            <div class="invalid-feedback">{{ form.categorie.errors|first }}</div>
          {% endif %}
        </div>
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea name="description" rows="4" class="form-control">{% if form %}{{ form.description.value|default_if_none:'' }}{% else %}{{ produit.description|default:'' }}{% endif %}</textarea>
        </div>
        <div class="col-md-8">
          <label class="form-label">Image du produit</label>
          <input type="file" name="image" accept="image/*" class="form-control {% if form and form.image.errors %}is-invalid{% endif %}" />
          {% if form and form.image.errors %}
            <div class="invalid-feedback d-block">{{ form.image.errors|first }}</div>
          {% endif %}
          {% if produit and produit.image %}
            <div class="mt-2">
              <img src="{{ produit.image.url }}" alt="Aperçu" class="img-thumbnail" style="max-height: 140px;" />
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="clear_image" id="clear_image">
                <label class="form-check-label" for="clear_image">
                  Supprimer l'image actuelle
                </label>
              </div>
            </div>
          {% endif %}
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="actif" id="actifCheck"
                   {% if form.is_bound %}
                     {% if form.actif.value %}checked{% endif %}
                   {% elif produit %}
                     {% if produit.actif %}checked{% endif %}
                   {% else %}
                     checked
                   {% endif %}>
            <label class="form-check-label" for="actifCheck">
              Actif
            </label>
          </div>
        </div>
      </div>
      <div class="mt-4 d-flex gap-2">
        <button type="submit" class="btn btn-primary">Enregistrer</button>
        <a href="{% url 'admin_produits_list' %}" class="btn btn-outline-secondary">Annuler</a>
      </div>
    </form>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Désactiver la validation HTML5 pour permettre la validation côté serveur
    document.querySelector('form').setAttribute('novalidate', 'novalidate');
    
    // Gestion de la suppression de l'image
    const clearImageCheckbox = document.getElementById('clear_image');
    const imageInput = document.querySelector('input[type="file"]');
    if (clearImageCheckbox && imageInput) {
      clearImageCheckbox.addEventListener('change', function() {
        if (this.checked) {
          imageInput.disabled = true;
        } else {
          imageInput.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
