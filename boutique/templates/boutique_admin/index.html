{% load static humanize %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Admin | Tableau de bord</title>
  {% include 'includes/admin_theme_head.html' %}
</head>
<body class="admin">
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand" href="/">Glalex Admin</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'admin_stocks' %}">
          <i class="bi bi-box-seam me-1"></i>Gestion des stocks
        </a>
        <button type="button" id="adminThemeToggle" class="btn btn-outline-secondary" title="Mode sombre">
          <i class="bi bi-moon"></i>
        </button>
        <a class="btn btn-outline-secondary" href="/"><i class="bi bi-house me-1"></i>Accueil</a>
        <a class="btn btn-outline-secondary" href="/boutique/"><i class="bi bi-shop me-1"></i>Boutique</a>
        <a class="btn btn-outline-dark" href="/deconnexion/"><i class="bi bi-box-arrow-right me-1"></i>Se déconnecter</a>
      </div>
    </div>
  </nav>

  <main class="container py-4 py-md-5">
    <!-- Heading -->
    <div class="mb-3">
      <h1 class="h3 mb-1">Tableau de bord</h1>
      <div class="text-muted small">Bienvenue, {{ request.user.first_name|default:request.user.username }} !
        {% if last_login %}Dernière connexion : {{ last_login|date:"d/m/Y H:i" }}{% endif %}
      </div>
    </div>

    <!-- Unified Tasks Panel -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <div class="card card-elev">
          <div class="card-body py-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-list-task"></i>
                <h2 class="h6 m-0">Tâches à traiter</h2>
              </div>
              <span class="badge bg-secondary">Temps réel</span>
            </div>
            <div class="row g-2 g-md-3">
              <!-- Ruptures -->
              <div class="col-12 col-sm-6 col-lg-3">
                <a href="{% url 'admin_stocks' %}" class="text-decoration-none">
                  <div class="p-3 border rounded d-flex align-items-center gap-3">
                    <span class="icon-only" style="background:#fff1f0;color:#dc3545"><i class="bi bi-x-octagon"></i></span>
                    <div class="flex-grow-1">
                      <div class="small text-muted">Ruptures</div>
                      <div class="fw-bold">{{ dash_zero_count|default:0 }}</div>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                  </div>
                </a>
              </div>
              <!-- Stocks faibles -->
              <div class="col-12 col-sm-6 col-lg-3">
                <a href="{% url 'admin_stocks' %}" class="text-decoration-none">
                  <div class="p-3 border rounded d-flex align-items-center gap-3">
                    <span class="icon-only" style="background:#fff9db;color:#664d03"><i class="bi bi-exclamation-circle"></i></span>
                    <div class="flex-grow-1">
                      <div class="small text-muted">Stocks ≤ {{ low_threshold }}</div>
                      <div class="fw-bold">{{ dash_low_count|default:0 }}</div>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                  </div>
                </a>
              </div>
              <!-- Messages clients non lus -->
              <div class="col-12 col-sm-6 col-lg-3">
                <a href="{% url 'admin_inbox' %}" class="text-decoration-none">
                  <div class="p-3 border rounded d-flex align-items-center gap-3">
                    <span class="icon-only" style="background:#f5f7fa;color:#0d6efd"><i class="bi bi-envelope"></i></span>
                    <div class="flex-grow-1">
                      <div class="small text-muted">Clients (non lus)</div>
                      <div class="fw-bold">{{ dash_unread_clients|default:0 }}</div>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                  </div>
                </a>
              </div>
              <!-- Messages livreurs non lus -->
              <div class="col-12 col-sm-6 col-lg-3">
                <a href="{% url 'admin_inbox' %}" class="text-decoration-none">
                  <div class="p-3 border rounded d-flex align-items-center gap-3">
                    <span class="icon-only" style="background:#eef7ff;color:#0d6efd"><i class="bi bi-chat-dots"></i></span>
                    <div class="flex-grow-1">
                      <div class="small text-muted">Livreurs (non lus)</div>
                      <div class="fw-bold">{{ dash_unread_livreurs|default:0 }}</div>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                  </div>
                </a>
              </div>
              <!-- Nouvelles commandes aujourd'hui -->
              <div class="col-12 col-sm-6 col-lg-3">
                <a href="{% url 'admin_commandes_list' %}" class="text-decoration-none">
                  <div class="p-3 border rounded d-flex align-items-center gap-3">
                    <span class="icon-only" style="background:#e7f7ef;color:#198754"><i class="bi bi-bag-check"></i></span>
                    <div class="flex-grow-1">
                      <div class="small text-muted">Nouvelles commandes (aujourd'hui)</div>
                      <div class="fw-bold">{{ dash_new_orders_today|default:0 }}</div>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                  </div>
                </a>
              </div>
            </div>
            <div class="text-muted small mt-2">
              Les tâches disparaissent automatiquement lorsqu'elles sont traitées (ex: messages lus, stock corrigé, etc.).
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="row g-3 g-md-4 mb-4">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="metric-card p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <span class="metric-icon"><i class="bi bi-people fs-5"></i></span>
            <div>
              <div class="text-muted small">Clients</div>
              <div class="fs-4 fw-bold">{{ clients_count|default:0|intcomma }}</div>
              <div class="text-success small">+12% ce mois-ci</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="metric-card p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <span class="metric-icon"><i class="bi bi-coin fs-5"></i></span>
            <div>
              <div class="text-muted small">Chiffre d'affaires</div>
              <div class="fs-4 fw-bold">{{ chiffre_affaires|default:0|floatformat:0|intcomma }} FCFA</div>
              <div class="text-success small">+8% ce mois-ci</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="metric-card p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <span class="metric-icon"><i class="bi bi-bar-chart-line fs-5"></i></span>
            <div>
              <div class="text-muted small">Commandes</div>
              <div class="fs-4 fw-bold">{{ commandes_count|default:0|intcomma }}</div>
              <div class="text-danger small">-3% ce mois-ci</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="metric-card p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <span class="metric-icon"><i class="bi bi-box-seam fs-5"></i></span>
            <div>
              <div class="text-muted small">Produits actifs</div>
              <div class="fs-4 fw-bold">{{ produits_actifs|default:0|intcomma }}</div>
              <div class="text-muted small">Stable</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gestion (ancien contenu, mieux organisé) -->
    <section class="mt-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="h6 m-0">Gestion</h2>
        <span class="badge badge-soft">Raccourcis</span>
      </div>
      <div class="row g-3 g-md-4">
        <!-- Gestion des livreurs -->
        <div class="col-md-6 col-lg-4">
          <div class="card card-elev h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-truck"></i><h3 class="h6 m-0">Gestion des livreurs</h3></div>
              <p class="text-muted small">Créer et administrer les comptes livreurs.</p>
              <div class="mt-auto d-flex flex-wrap gap-2">
                <a class="btn btn-brand" href="{% url 'admin_livreur_add' %}">Ajouter Livreur</a>
                <a class="btn btn-outline-primary" href="{% url 'admin_livreurs_list' %}">Gérer Livreurs</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Commandes -->
        <div class="col-md-6 col-lg-4">
          <div class="card card-elev h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-bag-check"></i><h3 class="h6 m-0">Commandes</h3></div>
              <p class="text-muted small">Consulter et suivre les commandes.</p>
              <div class="mt-auto">
                <a class="btn btn-outline-primary" href="{% url 'admin_commandes_list' %}">Voir les commandes</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Produits & Catégories & Stock -->
        <div class="col-md-6 col-lg-4">
          <div class="card card-elev h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-box-seam"></i><h3 class="h6 m-0">Produits</h3></div>
              <p class="text-muted small">Ajouter et gérer les produits et catégories.</p>
              <div class="mt-auto d-flex flex-wrap gap-2">
                <a class="btn btn-brand" href="{% url 'admin_produit_add' %}">Ajouter Produit</a>
                <a class="btn btn-outline-primary" href="{% url 'admin_produits_list' %}">Gérer Produits</a>
                <a class="btn btn-outline-secondary" href="{% url 'admin_categories_list' %}">Catégories</a>
                <a class="btn btn-outline-dark" href="{% url 'admin_stocks' %}"><i class="bi bi-clipboard-data me-1"></i>Gestion des stocks</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Clients -->
        <div class="col-md-6 col-lg-4">
          <div class="card card-elev h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-people"></i><h3 class="h6 m-0">Clients</h3></div>
              <p class="text-muted small">Voir et gérer les profils clients.</p>
              <div class="mt-auto">
                <a class="btn btn-outline-secondary" href="{% url 'admin_clients_list' %}">Gérer Clients</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Ventes -->
        <div class="col-md-6 col-lg-4">
          <div class="card card-elev h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-graph-up-arrow"></i><h3 class="h6 m-0">Ventes</h3></div>
              <p class="text-muted small">Accéder aux ventes confirmées (payées).</p>
              <div class="mt-auto d-flex flex-wrap gap-2">
                <a class="btn btn-brand" href="{% url 'admin_ventes_semaine' %}">Voir les ventes</a>
                <a class="btn btn-outline-primary" href="{% url 'admin_ventes_jour' %}">Jour</a>
                <a class="btn btn-outline-primary" href="{% url 'admin_ventes_semaine' %}">Semaine</a>
                <a class="btn btn-outline-primary" href="{% url 'admin_ventes_mois' %}">Mois</a>
                <a class="btn btn-outline-primary" href="{% url 'admin_ventes_annee' %}">Année</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const body = document.body;
      const key = 'adminTheme';
      const toggleBtn = document.getElementById('adminThemeToggle');
      const saved = localStorage.getItem(key);
      const apply = (mode)=>{
        if(mode === 'dark'){
          body.classList.add('admin-dark');
          if(toggleBtn){ toggleBtn.title = 'Mode clair'; toggleBtn.innerHTML = '<i class="bi bi-sun"></i>'; }
        } else {
          body.classList.remove('admin-dark');
          if(toggleBtn){ toggleBtn.title = 'Mode sombre'; toggleBtn.innerHTML = '<i class="bi bi-moon"></i>'; }
        }
      };
      if(saved){ apply(saved); }
      if(toggleBtn){
        toggleBtn.addEventListener('click', function(){
          const next = body.classList.contains('admin-dark') ? 'light' : 'dark';
          localStorage.setItem(key, next);
          apply(next);
        });
      }
    })();
  </script>
</body>
</html>
